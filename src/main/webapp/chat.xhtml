<!DOCTYPE html>
<html lang="#{localeBean.language}"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core">
<ui:composition template="/template.xhtml">
    <ui:define name="header">#{msg['chat.title']}</ui:define>
    <ui:define name="content">
        <h2>#{msg['chat.title']}</h2>
        <hr />

        <div style="display: flex; gap: 2rem;">
            <!-- Chat Panel -->
            <div style="flex: 1;">
                <div style="border: 1px solid #ccc; padding: 1rem; border-radius: 4px;">
                    <h3 style="margin-top: 0;">#{msg['chat.messages']}</h3>

                    <!-- Messages Display -->
                    <div id="chatMessages"
                         style="border: 1px solid #dee2e6; height: 400px; overflow-y: auto; padding: 10px;
                                margin-bottom: 1rem; background-color: #f8f9fa; border-radius: 5px;">
                        <p style="text-align: center; color: #666;">#{msg['chat.noMessages']}</p>
                    </div>

                    <!-- Message Input Form -->
                    <h:form id="chatForm">
                        <h:messages id="chatFormMessages" globalOnly="true"
                                  style="color: red; margin-bottom: 1rem;"
                                  role="alert" />

                        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                            <!-- Recipient Selection -->
                            <div style="flex: 0 0 200px;">
                                <label for="recipientSelect">#{msg['chat.sendTo']}:</label>
                                <h:selectOneMenu id="recipientSelect"
                                               value="#{chatView.selectedRecipient}"
                                               style="width: 100%; padding: 0.5rem;">
                                    <f:selectItem itemValue="ALL" itemLabel="#{msg['chat.everyone']}" />
                                    <f:selectItems value="#{chatView.allUsers}"
                                                 var="user"
                                                 itemValue="#{user.login}"
                                                 itemLabel="#{user.login}" />
                                </h:selectOneMenu>
                            </div>

                            <!-- Message Input -->
                            <div style="flex: 1;">
                                <label for="messageInput">#{msg['chat.message']}:</label>
                                <h:inputText id="messageInput"
                                           value="#{chatView.messageContent}"
                                           style="width: 100%; padding: 0.5rem;"
                                           placeholder="#{msg['chat.placeholder']}"
                                           onkeypress="if(event.keyCode==13){document.getElementById('chatForm:sendBtn').click();return false;}" />
                            </div>

                            <!-- Send Button -->
                            <div>
                                <h:commandButton id="sendBtn"
                                               value="#{msg['chat.send']}"
                                               action="#{chatView.sendMessage}"
                                               style="padding: 0.5rem 1.5rem; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <f:ajax execute="@form" render="chatFormMessages recipientSelect messageInput" />
                                </h:commandButton>
                            </div>
                        </div>
                    </h:form>
                </div>
            </div>

            <!-- Sidebar -->
            <div style="width: 250px;">
                <!-- Online Users Panel -->
                <div style="border: 1px solid #ccc; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <h3 style="margin-top: 0;">#{msg['chat.onlineUsers']}</h3>
                    <ul id="onlineUsersList" style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 0.5rem; color: #666;">#{msg['chat.connecting']}</li>
                    </ul>
                </div>

                <!-- Status Panel -->
                <div style="border: 1px solid #ccc; padding: 1rem; border-radius: 4px;">
                    <h3 style="margin-top: 0;">#{msg['chat.status']}</h3>
                    <p>
                        <strong>#{msg['chat.loggedAs']}:</strong><br />
                        #{chatView.currentUsername}
                    </p>
                    <p>
                        <strong>#{msg['chat.connectionStatus']}:</strong><br />
                        <span id="wsStatus" style="display: inline-block; padding: 0.25rem 0.5rem; background-color: #ffc107; color: #000; border-radius: 4px; font-size: 0.875rem;">
                            #{msg['chat.connecting']}
                        </span>
                    </p>
                </div>
            </div>
        </div>

        <!-- WebSocket JavaScript -->
        <script type="text/javascript">
            //<![CDATA[
            var chatSocket;
            var currentUsername = "#{chatView.currentUsername}";
            var contextPath = "#{request.contextPath}";

            document.addEventListener("DOMContentLoaded", function() {
                connectWebSocket();
            });

            function connectWebSocket() {
                var wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                var wsUrl = wsProtocol + "//" + window.location.host + contextPath +
                           "/chat-websocket?username=" + encodeURIComponent(currentUsername);

                console.log("Connecting to WebSocket: " + wsUrl);

                try {
                    chatSocket = new WebSocket(wsUrl);

                    chatSocket.onopen = function(event) {
                        console.log("WebSocket connected");
                        var statusElement = document.getElementById("wsStatus");
                        statusElement.textContent = '#{msg["chat.connected"]}';
                        statusElement.style.backgroundColor = '#28a745';
                        statusElement.style.color = '#fff';
                    };

                    chatSocket.onmessage = function(event) {
                        console.log("Received message: " + event.data);
                        var data = JSON.parse(event.data);

                        if (data.type === "userList") {
                            updateOnlineUsers(data.users);
                        } else {
                            addChatMessage(data);
                        }
                    };

                    chatSocket.onclose = function(event) {
                        console.log("WebSocket disconnected");
                        var statusElement = document.getElementById("wsStatus");
                        statusElement.textContent = '#{msg["chat.disconnected"]}';
                        statusElement.style.backgroundColor = '#dc3545';
                        statusElement.style.color = '#fff';

                        setTimeout(connectWebSocket, 5000);
                    };

                    chatSocket.onerror = function(error) {
                        console.error("WebSocket error:", error);
                        var statusElement = document.getElementById("wsStatus");
                        statusElement.textContent = '#{msg["chat.error"]}';
                        statusElement.style.backgroundColor = '#dc3545';
                        statusElement.style.color = '#fff';
                    };
                } catch (e) {
                    console.error("Failed to create WebSocket:", e);
                }
            }

            function addChatMessage(message) {
                var messagesContainer = document.getElementById("chatMessages");

                var placeholder = messagesContainer.querySelector("p");
                if (placeholder && placeholder.textContent.indexOf('#{msg["chat.noMessages"]}') >= 0) {
                    placeholder.remove();
                }

                var messageDiv = document.createElement("div");
                messageDiv.style.marginBottom = "0.5rem";
                messageDiv.style.padding = "0.5rem";
                messageDiv.style.borderRadius = "4px";

                var isOwnMessage = message.sender === currentUsername;
                var isPrivate = message.privateMessage;

                if (isOwnMessage) {
                    messageDiv.style.backgroundColor = "#e3f2fd";
                    messageDiv.style.textAlign = "right";
                    messageDiv.style.marginLeft = "auto";
                    messageDiv.style.maxWidth = "70%";
                } else if (isPrivate) {
                    messageDiv.style.backgroundColor = "#fff3cd";
                    messageDiv.style.maxWidth = "70%";
                } else {
                    messageDiv.style.backgroundColor = "#f5f5f5";
                    messageDiv.style.maxWidth = "70%";
                }

                var senderInfo = "<strong>" + escapeHtml(message.sender) + "</strong>";
                if (isPrivate) {
                    if (isOwnMessage) {
                        senderInfo += ' <span style="background-color: #343a40; color: #fff; padding: 0.125rem 0.25rem; border-radius: 3px; font-size: 0.75rem;">→ ' +
                                     escapeHtml(message.recipient) + '</span>';
                    } else {
                        senderInfo += ' <span style="background-color: #343a40; color: #fff; padding: 0.125rem 0.25rem; border-radius: 3px; font-size: 0.75rem;">#{msg["chat.privateMessage"]}</span>';
                    }
                }

                var timestamp = "";
                if (message.timestamp) {
                    var date = new Date(message.timestamp);
                    timestamp = date.toLocaleTimeString();
                }

                messageDiv.innerHTML =
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">' +
                    '<small>' + senderInfo + '</small>' +
                    '<small style="color: #999;">' + timestamp + '</small>' +
                    '</div>' +
                    '<div>' + escapeHtml(message.content) + '</div>';

                messagesContainer.appendChild(messageDiv);

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function updateOnlineUsers(users) {
                var usersList = document.getElementById("onlineUsersList");
                usersList.innerHTML = "";

                if (users && users.length > 0) {
                    users.forEach(function(user) {
                        var li = document.createElement("li");
                        li.style.display = "flex";
                        li.style.justifyContent = "space-between";
                        li.style.alignItems = "center";
                        li.style.padding = "0.5rem";
                        li.style.borderBottom = "1px solid #eee";

                        var userSpan = document.createElement("span");
                        userSpan.textContent = user;
                        li.appendChild(userSpan);

                        if (user === currentUsername) {
                            var youBadge = document.createElement("span");
                            youBadge.textContent = '#{msg["chat.you"]}';
                            youBadge.style.backgroundColor = "#007bff";
                            youBadge.style.color = "#fff";
                            youBadge.style.padding = "0.125rem 0.375rem";
                            youBadge.style.borderRadius = "3px";
                            youBadge.style.fontSize = "0.75rem";
                            youBadge.style.marginLeft = "0.5rem";
                            li.appendChild(youBadge);
                        }

                        var onlineDot = document.createElement("span");
                        onlineDot.textContent = "●";
                        onlineDot.style.color = "#28a745";
                        onlineDot.style.marginLeft = "0.5rem";
                        li.appendChild(onlineDot);

                        usersList.appendChild(li);
                    });
                } else {
                    var li = document.createElement("li");
                    li.style.padding = "0.5rem";
                    li.style.color = "#666";
                    li.textContent = '#{msg["chat.noUsersOnline"]}';
                    usersList.appendChild(li);
                }
            }

            function escapeHtml(text) {
                var div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }
            //]]>
        </script>

        <style>
            #chatMessages::-webkit-scrollbar {
                width: 8px;
            }
            #chatMessages::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            #chatMessages::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }
            #chatMessages::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        </style>
    </ui:define>
</ui:composition>
</html>
